<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MC 投影查看器</title>
    <meta name="author" content="滄海水魚">
    <meta name="description" content="上传 Minecraft 投影文件 (.litematic / .nbt / .schematic)，浏览 3D 投影并统计方块数量。">
    <meta name="theme-color" content="#ffffff">

    <link rel="manifest" href="/manifest.json">
    <link rel="icon" href="/resource/img/shell/favicon.ico" type="image/x-icon">
    <link rel="preload" href="/resource/img/shell/favicon.ico" as="image" type="image/x-icon">
    <link rel="preload" href="/resource/img/shell/shuiyu.avif" as="image" type="image/avif">
    <link rel="preload" href="/resource/img/shell/bg/bg-light-1.png" as="image" type="image/png">
    <link rel="preload" href="/css/variables.css" as="style">
    <link rel="preload" href="/resource/font/FluentSystemIcons-Regular.woff2" as="font" type="font/woff2" crossorigin>

    <link rel="stylesheet" href="/css/variables.css">
    <link rel="stylesheet" href="/css/input.css">
    <link rel="stylesheet" href="/css/header.css">
    <link rel="stylesheet" href="/css/sidebar.css">
    <link rel="stylesheet" href="/css/main-content.css">
    <link rel="stylesheet" href="/css/footer.css">
    <link rel="stylesheet" href="/css/lightbox.css">
    <link rel="stylesheet" href="/css/settings-modal.css">
    <link rel="stylesheet" href="/css/scroll-to-top.css">
    <link rel="stylesheet" href="/css/videoplay.css">
    <link rel="stylesheet" href="/css/column.css">
    <link rel="stylesheet" href="/css/project.css">
    <link rel="stylesheet" href="/css/tool-mc-projection.css">
    <link rel="stylesheet" href="/resource/font/FluentSystemIcons-Regular.css">

    <script src="/js/pwa/register-sw.js" defer></script>
    <script src="/js/theme.js" defer></script>
    <script src="/js/sidebar.js" defer></script>
    <script src="/js/lightbox.js" defer></script>
    <script src="/js/avatar.js" defer></script>
    <script src="/js/scroll-to-top.js" defer></script>
    <script src="/js/search.js" defer></script>
    <script src="/js/spa-router.js" defer></script>
    <script src="/js/settings-modal.js" defer></script>
    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.159.0/build/three.module.js"
            }
        }
    </script>

</head>

<body>
    <div id="shell-root"></div>
    <script>
        (function () {
            var container = document.getElementById('shell-root');
            function normalize(pathname) {
                var p = pathname.replace(/\/index\.html$/i, '/').replace(/\.html$/i, '').replace(/\/+$/, '');
                return p === '' ? '/' : p;
            }
            function markCurrentNav() {
                var current = normalize(location.pathname);
                var sidebar = document.getElementById('sidebar');
                if (!sidebar) return;
                sidebar.querySelectorAll('.current, .selected').forEach(function (el) {
                    el.classList.remove('current', 'selected');
                    if (el.tagName === 'A') el.removeAttribute('aria-current');
                });
                document.querySelectorAll('#sidebar a[href]').forEach(function (a) {
                    var href = a.getAttribute('href');
                    if (!href) return;
                    var target = normalize(new URL(href, location.origin).pathname);
                    if (target === current) {
                        var parent = a.closest('.has-children');
                        var toggle = parent ? parent.querySelector('.toggle') : null;
                        var submenu = parent ? parent.querySelector('.submenu') : null;
                        var parentOpen = !!(parent && parent.classList.contains('open'));

                        if (parent && !parentOpen) {
                            parent.classList.add('current');
                            if (toggle) toggle.classList.add('current');
                            return;
                        }

                        a.classList.add('current', 'selected');
                        a.setAttribute('aria-current', 'page');
                        if (parent) {
                            if (toggle) {
                                toggle.classList.add('current');
                                toggle.setAttribute('aria-expanded', 'true');
                            }
                            if (submenu) submenu.style.maxHeight = submenu.scrollHeight + 'px';
                        }
                    }
                });
            }
            function attachShell(html) {
                if (!container || !html) return;
                container.innerHTML = html;
                var move = function () {
                    var main = document.querySelector('main');
                    if (!main) return;
                    var aside = container.querySelector('aside');
                    var footer = container.querySelector('footer');
                    if (aside && !main.contains(aside)) {
                        aside.setAttribute('data-shell-moved', '1');
                        main.appendChild(aside);
                    }
                    if (footer && footer.parentNode !== main.parentNode) {
                        footer.setAttribute('data-shell-moved', '1');
                        main.insertAdjacentElement('afterend', footer);
                    }
                    if (window.refreshAsideStack) {
                        window.refreshAsideStack();
                    }
                    markCurrentNav();
                };
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', move, { once: true });
                } else {
                    move();
                }
            }
            function bust(url) {
                if (location.protocol === 'file:') return url;
                var sep = url.indexOf('?') === -1 ? '?' : '&';
                return url + sep + 'ts=' + Date.now();
            }
            try {
                var xhr = new XMLHttpRequest();
                xhr.open('GET', bust('/includes/shell.html'), false);
                xhr.send(null);
                if (xhr.status === 200 || xhr.status === 0) {
                    attachShell(xhr.responseText);
                    return;
                }
            } catch (e) {}
            fetch(bust('/includes/shell.html'), { cache: 'no-store' })
                .then(function(resp){ return resp.ok ? resp.text() : Promise.reject(new Error('HTTP '+resp.status)); })
                .then(function(html){ attachShell(html); });
        })();
    </script>

    <main>
        <div class="column-stack">
            <section class="article-card">
                <p class="eyebrow">工具</p>
                <h1>MC 投影查看器</h1>
                <p class="article-subtitle">上传 .litematic / .nbt / .schematic，浏览 3D 投影、统计方块数量，支持 WASD + 鼠标查看。</p>
                <div class="article-meta">
                    <span class="pill"><i class="icon-ic_fluent_shape_exclude_24_regular" aria-hidden="true"></i> 体素渲染</span>
                    <span class="pill"><i class="icon-ic_fluent_full_screen_maximize_24_regular" aria-hidden="true"></i> 全屏查看</span>
                    <span class="pill"><i class="icon-ic_fluent_data_usage_24_regular" aria-hidden="true"></i> 方块统计</span>
                </div>
                <div class="article-actions">
                    <a href="#tool-panel">立即使用</a>
                    <a href="#howto">使用说明</a>
                </div>
            </section>

            <section class="article-card mcproj-tool-card" id="tool-panel">
                <div class="mcproj-grid">
                    <div>
                        <p class="eyebrow">文件</p>
                        <h2>上传投影文件</h2>
                        <p class="article-subtitle">支持 .litematic / .nbt / .schematic，解析后会显示 3D 预览与统计。</p>
                        <div class="mcproj-drop" id="mcproj-drop" tabindex="0" aria-label="拖放或点击选择文件">
                            <input type="file" id="mcproj-file" accept=".litematic,.nbt,.schematic,.schem" aria-label="选择投影文件">
                            <div class="mcproj-drop-inner">
                                <i class="icon-ic_fluent_cloud_arrow_up_24_regular" aria-hidden="true"></i>
                                <div>
                                    <p class="drop-title">拖放文件到此，或点击选择</p>
                                    <p class="drop-hint">建议文件体量 < 5 万方块以内；更大模型渲染可能卡顿。</p>
                                </div>
                            </div>
                        </div>
                        <div class="mcproj-file-meta" id="mcproj-file-meta">未选择文件</div>
                        <div class="mcproj-progress" id="mcproj-progress" aria-label="上传进度" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0" hidden>
                            <div class="mcproj-progress-bar" id="mcproj-progress-bar"></div>
                        </div>
                        <div class="mcproj-stats" id="mcproj-stats">
                            <div class="stat">
                                <p class="stat-label">总方块</p>
                                <p class="stat-value" id="mcproj-total">-</p>
                            </div>
                            <div class="stat">
                                <p class="stat-label">尺寸</p>
                                <p class="stat-value" id="mcproj-size">-</p>
                            </div>
                            <div class="stat">
                                <p class="stat-label">方块种类</p>
                                <p class="stat-value" id="mcproj-unique">-</p>
                            </div>
                        </div>
                        <div class="mcproj-table-wrapper">
                            <table class="mcproj-table" aria-label="方块统计表">
                                <thead>
                                    <tr>
                                        <th>方块</th>
                                        <th>数量</th>
                                    </tr>
                                </thead>
                                <tbody id="mcproj-table-body">
                                    <tr><td colspan="2">等待解析...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div>
                        <p class="eyebrow">渲染</p>
                        <div class="mcproj-viewer">
                            <div class="mcproj-viewer-toolbar">
                                <div>
                                    <span class="pill pill-light" id="mcproj-status">未载入</span>
                                </div>
                                <div class="mcproj-viewer-actions">
                                    <button type="button" id="mcproj-fullscreen" aria-label="全屏切换">
                                        <i class="icon-ic_fluent_full_screen_maximize_24_regular" aria-hidden="true"></i>
                                        <span>全屏</span>
                                    </button>
                                </div>
                            </div>
                            <div class="mcproj-canvas-wrap" id="mcproj-canvas-wrap">
                                <canvas id="mcproj-canvas" aria-label="3D 预览"></canvas>
                                <div class="mcproj-crosshair" aria-hidden="true"></div>
                                <div class="mcproj-hud" id="mcproj-hud" aria-hidden="true">
                                    <div>方块：<span id="mcproj-focus">-</span></div>
                                    <div>FPS：<span id="mcproj-hud-fps">-</span></div>
                                    <div>方块：<span id="mcproj-hud-blocks">-</span></div>
                                    <div>位置：<span id="mcproj-hud-pos">-, -, -</span></div>
                                </div>
                            </div>
                            <div class="mcproj-hints">
                                <p><strong>操作：</strong>点击画面获取鼠标锁定，W/A/S/D 移动，空格上升，Shift 下降，鼠标移动视角，Esc 退出锁定。</p>
                                <p><strong>提示：</strong>仅渲染方块外形，不含碰撞；文件越大越耗资源。</p>
                            </div>
                            <div class="mcproj-speed">
                                <label for="mcproj-speed-input">移动速度</label>
                                <input type="number" id="mcproj-speed-input" class="styled-input" min="2" max="100" step="1" value="50" aria-label="移动速度，可输入数值">
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section class="article-card" id="howto">
                <h2>使用说明</h2>
                <ul>
                    <li>上传文件后会自动解析，支持 .litematic / .nbt / .schematic。若模型过大，渲染前会提示风险。</li>
                    <li>点击预览区域进入鼠标锁定，用 WASD/空格/Shift 移动，Esc 退出锁定。</li>
                    <li>全屏：点击“全屏”按钮进入/退出全屏，可在更大视野下查看。</li>
                    <li>方块统计：面板会列出总方块数、尺寸以及每种方块的数量分布。</li>
                </ul>
            </section>

            <section class="article-card">
                <h2>兼容性与限制</h2>
                <ul>
                    <li>解析依赖浏览器内存与显卡性能，建议先用较小模型测试，避免一次性加载超大工程。</li>
                    <li>.litematic 解析基于标准 BlockStatePalette；如文件包含特殊数据或极大 region，可能渲染不完整。</li>
                    <li>.schematic 以经典格式解析；若为 1.13+ palette 格式，可能存在颜色/方块名偏差。</li>
                </ul>
            </section>

        </div>
        <script src="/js/item-slot.js?v=20260219-17" defer></script>
        <script type="module" src="/js/tool/mc-projection.js?v=20260219-23" defer></script>
    </main>
    </body>

</html>
